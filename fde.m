function[t0,t1,t2]=fde(t0,t1,t2,v,Nx,Nz,dx,dz,dt,ba)

%Calcolo di derivazione (bordi non considerati)
%     for n=2:(Nx-1)
%         for j=2:(Nz-1)
%             t2(n,j)=-t0(n,j)+2*t1(n,j)+(v(n,j)^2)*(dt^2)*(((t1(n+1,j)-2*t1(n,j)+t1(n-1,j))/(dx^2))+((t1(n,j+1)-2*t1(n,j)+t1(n,j-1))/(dz^2)));
%         end
%     end
    
NN=2:(Nz-1);
JJ=2:(Nx-1);
t2(NN,JJ)=-t0(NN,JJ)+2*t1(NN,JJ)+...
  (v(NN,JJ).^2).*(dt^2).* ...
  (((t1(NN+1,JJ)-2*t1(NN,JJ)+t1(NN-1,JJ))./(dx^2))+ ...
  ((t1(NN,JJ+1)-2*t1(NN,JJ)+t1(NN,JJ-1))/(dz^2)));
 

%Calcolo del contorno
%     t2(:,1)=t1(:,1)-v(:,1).*dt./dx.*(t1(:,1)-t1(:,2));
%     t2(1,:)=t1(1,:)-v(1,:).*dt./dx.*(t1(1,:)-t1(2,:));
%     t2(:,Nz)=t1(:,Nz)-v(:,Nz).*dt./dx.*(t1(:,Nz)-t1(:,Nz-1));
%     t2(Nx,:)=t1(Nx,:)-v(Nx,:).*dt./dx.*(t1(Nx,:)-t1(Nx-1,:));

   
if(ba==1)
    % Assorbimento superiore

      t2(3:Nz-2,1) = (2.*v(3:Nz-2,1).*dx*dt.^2)./(dx+v(3:Nz-2,1).*dt).*...
             ((t2(3:Nz-2,2)./(2*dt*dx) - t0(3:Nz-2,2)./(2*dx*dt) + ....
             t0(3:Nz-2,1)./(2*dt*dx)) + ...
        (-1./(2.*dt.^2.*v(3:Nz-2,1))).*...
             (-2.*t1(3:Nz-2,1) + t0(3:Nz-2,1) -2.*t1(3:Nz-2,2)+ ...
             t0(3:Nz-2,2) + t2(3:Nz-2,2)) + ...
        v(3:Nz-2,1)./(4*dx.^2).*...
             (t2(4:Nz-1,2) + t0(4:Nz-1,1) + t2(2:Nz-3,2) - ...
              2.* t2(3:Nz-2,2) - 2.*t0(3:Nz-2,1) + t0(2:Nz-3,1)));


    % Assorbimento inferiore

    t2(3:Nz-2,Nx) = -2.*dx.*dt.^2.*v(3:Nz-2,Nx)./(dx+v(3:Nz-2,Nx).*dt).*...
           ((-t2(3:Nz-2,Nx-1)./(2*dt*dx) - t0(3:Nz-2,Nx)./(2*dt*dx) +...
           t0(3:Nz-2,Nx-1)./(2*dt*dx)) +...
      1./(2*dt.^2.*v(3:Nz-2,Nx)).*...
           (-2.*t1(3:Nz-2,Nx) + t0(3:Nz-2,Nx) + t2(3:Nz-2,Nx-1) - ...
           2.*t1(3:Nz-2,Nx-1) + t0(3:Nz-2,Nx-1)) + ...
      (-v(3:Nz-2,Nx)./(4*dx.^2)).* ...
           (t2(4:Nz-1,Nx-1) - 2.*t2(3:Nz-2,Nx-1) + t2(2:Nz-3,Nx-1) + ...
           t0(4:Nz-1,Nx) - 2.*t0(3:Nz-2,Nx) + t0(2:Nz-3,Nx)));

    % Assorbimento destra

    t2(Nz,3:Nx-2) =  -2.*dx.*dt.^2.*v(Nz,3:Nx-2)./(dx+v(Nz,3:Nx-2).*dt).*...
           ((-t2(Nz-1,3:Nx-2)./(2*dt*dx) - t0(Nz,3:Nx-2)./(2*dt*dx) + ...
           t0(Nz-1,3:Nx-2)./(2*dt*dx)) + ...
      1./(2*dt.^2.*v(Nz,3:Nx-2)).*...
           (-2.*t1(Nz,3:Nx-2) + t0(Nz,3:Nx-2) + t2(Nz-1,3:Nx-2) - ...
           2.*t1(Nz-1,3:Nx-2) + t0(Nz-1,3:Nx-2)) + ...
      (-v(Nz,3:Nx-2)./(4*dx.^2)).* ...
           (t2(Nz-1,4:Nx-1) - 2.*t2(Nz-1,3:Nx-2) + t2(Nz-1,2:Nx-3) + ...
           t0(Nz,4:Nx-1) - 2.*t0(Nz,3:Nx-2) + t0(Nz,2:Nx-3)));

    % Assorbimento sinistra

    t2(1,3:Nx-2) =(2.*v(1,3:Nx-2).*dx*dt.^2)./(dx+v(1,3:Nx-2).*dt).*...
           ((t2(2,3:Nx-2)./(2*dt*dx) - t0(2,3:Nx-2)./(2*dt*dx) + ...
           t0(1,3:Nx-2)./(2*dt*dx)) + ...
      (-1./(2*dt.^2.*v(1,3:Nx-2))).* ...
           (-2.*t1(1,3:Nx-2) + t0(1,3:Nx-2) + t2(2,3:Nx-2) - ...
           2.*t1(2,3:Nx-2) + t0(2,3:Nx-2)) + ...
      (v(1,3:Nx-2)./(4*dx.^2)).* ...
           (t2(2,4:Nx-1) - 2.*t2(2,3:Nx-2) + t2(2,2:Nx-3) +...
           t0(1,4:Nx-1) - 2.*t0(1,3:Nx-2) + t0(1,2:Nx-3)));

    %------------- Assorbimento angoli ------------------------------------------ 

    % Angolo basso-dx

    t2(Nz,Nx-1) = v(Nz,Nx-1).*dt.*dx./(2.*v(Nz,Nx-1).*dt + (2^1/2)*dx).*...
           (t2(Nz,Nx-2)./dx + t2(Nz-1,Nx-1)./dx + ...
           (2^1/2)/(v(Nz,Nx-1).*dt)*t1(Nz,Nx-1));

    t2(Nz-1,Nx) = v(Nz-1,Nx).*dt.*dx./(2.*v(Nz-1,Nx).*dt + (2^1/2)*dx).*...
           (t2(Nz-1,Nx-1)./dx + t2(Nz-2,Nx)./dx + ...
           (2^1/2)/(v(Nz-1,Nx).*dt)*t1(Nz-1,Nx));

    t2(Nz,Nx) = v(Nz,Nx).*dt.*dx./(2.*v(Nz,Nx).*dt + (2^1/2)*dx).*...
           (t2(Nz,Nx-1)./dx + t2(Nz-1,Nx)./dx + ...
           (2^1/2)/(v(Nz,Nx).*dt)*t1(Nz,Nx));

    % Angolo basso-sx

    t2(1,Nx-1) = v(1,Nx-1).*dt.*dx./(2.*v(1,Nx-1).*dt + (2^1/2)*dx).*...
           (t2(1,Nx-2)/dx + t2(2,Nx-1)/dx +...
           (2^1/2)/(v(1,Nx-1)*dt)*t1(1,Nx-1));

    t2(2,Nx) = v(2,Nx).*dt.*dx./(2.*v(2,Nx).*dt + (2^1/2)*dx).*...
           (t2(2,Nx-1)/dx + t2(3,Nx)/dx +...
           (2^1/2)/(v(2,Nx)*dt)*t1(2,Nx));

    t2(1,Nx,1) = v(1,Nx).*dt.*dx./(2.*v(1,Nx).*dt + (2^1/2)*dx).*...
           (t2(1,Nx-1)/dx + t2(2,Nx)/dx +...
           (2^1/2)/(v(1,Nx)*dt)*t1(1,Nx));


      % Angolo alto-dx

      t2(Nz,2) = v(Nz,2).*dt.*dx./(2.*v(Nz,2).*dt + (2^1/2)*dx).*...
             (t2(Nz,3)/dx + t2(Nz-1,2)/dx +...
             (2^1/2)/(v(Nz,2)*dt)*t1(Nz,2)); 

      t2(Nz-1,1) = v(Nz-1,1).*dt.*dx./(2.*v(Nz-1,1).*dt + (2^1/2)*dx).*...
             (t2(Nz-1,2)/dx + t2(Nz-2,1)/dx +...
             (2^1/2)/(v(Nz-1,1)*dt)*t1(Nz-1,1));

      t2(Nz,1) = v(Nz,1).*dt.*dx./(2.*v(Nz,1).*dt + (2^1/2)*dx).*...
             (t2(Nz,2)/dx + t2(Nz-1,1)/dx +...
             (2^1/2)/(v(Nz,1)*dt)*t1(Nz,1));

      % Angolo alto-sx

         % Angolo alto-sx

      t2(1,2) = v(1,2).*dt.*dx./(2.*v(1,2).*dt + (2^1/2)*dx).*...
             (t2(1,3)/dx + t2(2,2)/dx + ...
             (2^1/2)/(v(1,2)*dt)*t1(1,2));

      t2(2,1) = v(2,1).*dt.*dx./(2.*v(2,1).*dt + (2^1/2)*dx).*...
             (t2(2,2)/dx + t2(3,1)/dx + ...
             (2^1/2)/(v(2,1)*dt)*t1(2,1)); 

      t2(1,1) = v(1,1).*dt.*dx./(2.*v(1,1).*dt + (2^1/2)*dx).*...
             (t2(1,2)/dx + t2(2,1)/dx + ...
             (2^1/2)/(v(1,1)*dt)*t1(1,1));

end

end